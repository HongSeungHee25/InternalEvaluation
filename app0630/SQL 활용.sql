CREATE TABLE bookmember(
	mem_idx number(5,0)PRIMARY KEY,
	name varchar2(20)NOT NULL ,
	email varchar2(20)NOT NULL UNIQUE,
	tel varchar2(20),
	password varchar2(10)
);

CREATE TABLE books(
	bcode char(5)PRIMARY KEY,
	title varchar2(30)NOT NULL,
	writer varchar2(20)NOT NULL,
	publisher varchar2(20),
	pdate DATE
);

CREATE TABLE bookrent(
	rent_no NUMBER(5,0)PRIMARY KEY,
	mem_idx NUMBER(5,0)NOT NULL,
	bcode char(5)NOT NULL,
	rent_date DATE NOT NULL,
	exp_date DATE NOT NULL,
	return_date DATE,
	delay_days NUMBER(3,0)
);

ALTER TABLE bookrent
ADD CONSTRAINT mem_idx FOREIGN KEY (mem_idx)
	REFERENCES bookmember (mem_idx);
ALTER TABLE bookrent
ADD CONSTRAINT bcode FOREIGN KEY (bcode)
	REFERENCES books (bcode);

INSERT INTO BOOKMEMBER b VALUES (10001,'이하니','honey@naver.com','010-9889-0567','1122');
INSERT INTO BOOKMEMBER b VALUES (10002,'이세종','jong@daum.net','010-2354-6773','2345');
INSERT INTO BOOKMEMBER b VALUES (10003,'최행운','lucky@korea.com','010-5467-8792','9876');
INSERT INTO BOOKMEMBER b VALUES (10004,'나길동','nadong@kkk.net','010-3456-8765','3456');
INSERT INTO BOOKMEMBER b VALUES (10005,'강감찬','haha@korea.net','010-3987-9087','1234');

INSERT INTO BOOKS b VALUES ('A1101','코스모스','칼세이건','사이언스북스','2006-12-01');
INSERT INTO BOOKS b VALUES ('B1101','해커스토익','이해커','해커스랩','2018-07-10');
INSERT INTO BOOKS b VALUES ('C1101','푸른사자 와니니','이현','창비','2015-06-20');
INSERT INTO BOOKS b VALUES ('A1102','페스트','알베르트 까뮈','민음사','2011-03-01');

INSERT INTO BOOKRENT b VALUES (1,10001,'B1101',
timestamp'2023-05-01 14:22:00.0','2023-05-15',timestamp'2023-05-14 11:30:00.0',-1);
INSERT INTO BOOKRENT b VALUES (2,10002,'C1101',
timestamp'2023-06-12 17:04:00.0','2023-06-25',NULL,NULL);
INSERT INTO BOOKRENT b VALUES (3,10003,'B1101',
timestamp'2023-06-03 10:15:00.0','2023-06-17',timestamp'2023-06-17 11:33:00.0',0);
INSERT INTO BOOKRENT b VALUES (4,10004,'C1101',
timestamp'2023-04-03 13:34:00.0','2023-04-17',timestamp'2023-04-15 14:20:00.0',-2);
INSERT INTO BOOKRENT b VALUES (5,10001,'A1101',
timestamp'2023-06-16 11:11:00.0','2023-06-30',NULL,NULL);
INSERT INTO BOOKRENT b VALUES (6,10003,'A1102',
timestamp'2023-06-17 11:41:00.0','2023-07-01',NULL,NULL);
INSERT INTO BOOKRENT b VALUES (7,10002,'A1101',
timestamp'2023-05-15 13:42:00.0','2023-05-29',timestamp'2023-05-30 12:42:00.0',1);

-- 1)
SELECT RENT_NO , trunc(EXP_DATE) - TO_DATE(SYSDATE) AS "연체일수" 
FROM BOOKRENT b 
WHERE DELAY_DAYS IS NULL 
ORDER BY RENT_NO ;

-- 2)
SELECT BCODE , TITLE , WRITER 
FROM BOOKS b 
WHERE BCODE LIKE ('A%');

-- 3)
SELECT BCODE , TO_CHAR(RENT_DATE,'yyyy-mm-dd') AS "대여날짜"
FROM BOOKRENT b 
WHERE TO_CHAR(RENT_DATE,'yyyy-mm') = '2023-05';

-- 4)
SELECT br.MEM_IDX , b.NAME , b.TEL 
FROM BOOKMEMBER b JOIN BOOKRENT br
ON b.MEM_IDX  = br.MEM_IDX 
WHERE TRUNC(SYSDATE) = br.EXP_DATE ;

-- 5)
SELECT COUNT(b.BCODE) AS "대여횟수", bs.BCODE , bs.TITLE 
FROM BOOKRENT b JOIN BOOKS bs
ON b.BCODE = bs.BCODE 
GROUP BY bs.BCODE,bs.TITLE 
ORDER BY 대여횟수 DESC , BCODE ;

-- 6)
SELECT BCODE , COUNT(BCODE)  AS RENT_CNT
FROM BOOKRENT b 
GROUP BY BCODE 
HAVING COUNT(BCODE) = 1;

-- 7)
SELECT MEM_IDX 
FROM BOOKRENT b
GROUP BY MEM_IDX 
HAVING COUNT(RENT_NO) > 2
UNION   
SELECT MEM_IDX 
FROM BOOKRENT b 
WHERE delay_days IS NULL
MINUS 
SELECT MEM_IDX 
FROM BOOKRENT b 
WHERE DELAY_DAYS = 1;

